<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×¤×¨ ×”××ª×›×•× ×™× ×”××©×¤×—×ª×™</title>
    <link rel="stylesheet" href="style.css">
<style>
        /* ×¢×™×¦×•×‘ ×›×œ×œ×™ ×©×“×•××’ ×œ××¨×›×– ×”×¢××•×“ */
        body { 
            background-color: #f8f1e7; 
            margin: 0; 
            padding: 20px; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center; /* ××¨×›×– ××•×¤×§×™ */
        }

        .container { 
            width: 100%;
            max-width: 600px; /* ×–×” ×™×•×¦×¨ ××ª ×”××œ×‘×Ÿ ×”×™×¤×” */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ×¢×™×¦×•×‘ ×”×›×¨×˜×™×¡×™×•×ª (×”××œ×‘× ×™× ×”×œ×‘× ×™×) */
        .card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #e0d5c1;
        }

        .elegant-title { color: #5d4037; text-align: center; margin-bottom: 25px; }

        /* ×©×“×•×ª ×§×œ×˜ - ×©×œ× ×™××¨×—×• */
        input, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid #D4AF37;
            box-sizing: border-box; /* ×—×©×•×‘ ×××•×“ ×œ××‘× ×” ×”××œ×‘× ×™! */
            font-size: 1rem;
        }

        /* ×›×¤×ª×•×¨×™× */
        .btn-primary {
            background: #D4AF37;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .btn-add { background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-logout { background: #c62828; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-back { background: #607d8b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }

        /* ×¨×©×™××ª ××ª×›×•× ×™× */
        .recipe-card {
            background: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-right: 5px solid #D4AF37;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .recipe-card:hover { transform: scale(1.02); }

        .elegant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .upload-container { 
            border: 2px dashed #D4AF37; 
            padding: 20px; 
            text-align: center; 
            border-radius: 15px; 
            background: #fdfaf0; 
            cursor: pointer; 
            margin: 15px 0; 
            position: relative;
        }
        #file-input { position: absolute; opacity: 0; width: 100%; height: 100%; top:0; left:0; cursor: pointer; }
        #image-preview { max-width: 100%; border-radius: 10px; margin-top: 10px; display: none; }

        .recipe-tools { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tool-btn { background: white; border: 1px solid #D4AF37; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section" class="card fade-in">
        <h1 class="elegant-title">×¡×¤×¨ ×”××ª×›×•× ×™× ×©×œ ×§×•×œ×•××‘×•×¡ âœ¨</h1>
        <input type="text" id="username" placeholder="×©× ×”××©×ª××© ×©×œ×›×">
        <button onclick="login()" class="btn-primary animate-btn" style="width:100%;">×”×ª×—×‘×¨ ×•×”×ª×—×œ ×œ×‘×©×œ! ğŸ³</button>
    </div>

    <div id="recipe-list-screen" style="display:none;" class="fade-in">
        <header class="elegant-header">
            <h1 class="elegant-title">×”××ª×›×•× ×™× ×©×œ <span id="display-user"></span> ğŸ“š</h1>
            <div class="header-buttons">
                <button onclick="showAddRecipeScreen()" class="btn-add">+ ×”×•×¡×£ ××ª×›×•×Ÿ</button>
                <button onclick="location.reload()" class="btn-logout">×™×¦×™××” ğŸšª</button>
            </div>
        </header>
        
        <div class="search-container card">
            <input type="text" id="search-input" placeholder="×—×¤×©×™ ××ª×›×•×Ÿ..." oninput="filterRecipes()">
        </div>

        <div id="recipes-list"></div>
    </div>

    <div id="add-recipe-screen" style="display:none;" class="card fade-in">
        <button onclick="showListScreen()" class="btn-back">â†’ ×—×–×¨×”</button>
        <h3 class="elegant-title">××ª×›×•×Ÿ ×—×“×© ğŸ“</h3>
        <input type="text" id="recipe-title" placeholder="×©× ×”××ª×›×•×Ÿ">
        <textarea id="recipe-ingredients" rows="5" placeholder="××¦×¨×›×™×..."></textarea>
        <textarea id="recipe-instructions" rows="7" placeholder="××•×¤×Ÿ ×”×”×›× ×”..."></textarea>

        <div class="upload-container" id="drop-zone">
            <span style="font-size: 2rem;">ğŸ“¸</span>
            <p id="drop-text">×œ×—×¦×• ×›××Ÿ ××• ×’×¨×¨×• ×ª××•× ×”</p>
            <input type="file" id="file-input" accept="image/*">
            <img id="image-preview">
        </div>

        <button onclick="saveRecipe(event)" class="btn-primary" style="width:100%;">×©××•×¨ ××ª×›×•×Ÿ ×‘×¡×¤×¨! ğŸ‘‘</button>
    </div>

    <div id="single-recipe-screen" style="display:none;" class="card fade-in">
        <button onclick="showListScreen()" class="btn-back">â†’ ×—×–×¨×”</button>
        <div class="recipe-tools">
            <button onclick="toggleMusic()" id="music-btn" class="tool-btn">ğŸµ</button>
            <button onclick="readRecipe()" id="speak-btn" class="tool-btn">ğŸ”Š</button>
            <div class="like-system">
                <button onclick="handleVote('up')" class="tool-btn" style="border:none; width:30px; background:none;">ğŸ‘</button>
                <span id="like-count" style="font-weight:bold; color:#D4AF37;">0</span>
                <button onclick="handleVote('down')" class="tool-btn" style="border:none; width:30px; background:none;">ğŸ‘</button>
            </div>
        </div>
        <div id="full-recipe-content"></div>
        <div style="margin-top: 20px;">
            <button id="edit-btn-placeholder" class="btn-edit-small">×¢×¨×™×›×” âœ</button>
            <button id="delete-btn-placeholder" class="btn-delete-small">××—×™×§×” ğŸ—‘</button>
        </div>
    </div>
</div>

<script>
// ×”×§×•×“ ×©×œ ×”-JavaScript ×©×œ×š × ×©××¨ ×–×”×” ×œ×—×œ×•×˜×™×Ÿ ×•×¢×•×‘×“ ××¦×•×™×Ÿ
const OWNER = 'BrachaColumbus';
const REPO = 'our_family_recipies';
const FILE_PATH = 'recipes.json';
const TOKEN = "ghp_MQt8otTpwcEFn8pI" + "JIINq2p74o8Ypi3jOOzM";

let currentUser = "";
let allMyRecipes = [];
let editingIndex = null;
let currentImageData = "";
let myMagicPlayer = null;

function login() {
    const u = document.getElementById('username').value.trim();
    if(!u) return;
    let p = prompt("×¡×™×¡××” ××©×¤×—×ª×™×ª:");
    if (p === "××©×¤×—×ª ×§×•×œ×•××‘×•×¡ ×”××§×¡×™××”" || p === "××¨×™× ×’×œ×™×§") {
        currentUser = u;
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('recipe-list-screen').style.display = 'block';
        document.getElementById('display-user').innerText = currentUser;
        loadRecipes();
    } else { alert("×˜×¢×•×ª ×‘×¡×™×¡××”"); }
}

function processImage(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxWidth = 600;
            const scale = maxWidth / img.width;
            canvas.width = maxWidth;
            canvas.height = img.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            currentImageData = canvas.toDataURL('image/jpeg', 0.5);
            document.getElementById('image-preview').src = currentImageData;
            document.getElementById('image-preview').style.display = 'block';
            document.getElementById('drop-text').innerText = "×ª××•× ×” ××•×›× ×”! âœ…";
        };
    };
    reader.readAsDataURL(file);
}

window.onload = () => {
    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('file-input');
    if(dz) {
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.style.background = "#fdf6e3"; });
        dz.addEventListener('dragleave', () => { dz.style.background = "rgba(212, 175, 55, 0.05)"; });
        dz.addEventListener('drop', (e) => { e.preventDefault(); processImage(e.dataTransfer.files[0]); });
    }
    if(fi) { fi.addEventListener('change', (e) => processImage(e.target.files[0])); }
};

async function loadRecipes() {
    try {
        const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
            headers: { 'Authorization': `token ${TOKEN}` }
        });
        const data = await res.json();
        const content = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        allMyRecipes = content.filter(r => r.user === currentUser);
        renderList(allMyRecipes);
    } catch (e) { console.error(e); }
}

function renderList(recipes) {
    document.getElementById('recipes-list').innerHTML = recipes.map((r, i) => {
        const originalIndex = allMyRecipes.findIndex(item => item.title === r.title && item.ing === r.ing);
        return `<div class="recipe-card" onclick="openRecipe(${originalIndex})"><h3>${r.title} ğŸ¥˜</h3></div>`;
    }).join('');
}

function filterRecipes() {
    const term = document.getElementById('search-input').value.toLowerCase();
    const filtered = allMyRecipes.filter(r => 
        r.title.toLowerCase().includes(term) || 
        r.ing.toLowerCase().includes(term)
    );
    renderList(filtered);
}

function openRecipe(i) {
    const r = allMyRecipes[i];
    document.getElementById('recipe-list-screen').style.display = 'none';
    document.getElementById('single-recipe-screen').style.display = 'block';
    window.speechSynthesis.cancel();
    document.getElementById('speak-btn').innerHTML = "ğŸ”Š";
    document.getElementById('full-recipe-content').innerHTML = `
        <h2>${r.title}</h2>
        ${r.img ? `<img src="${r.img}" style="width:100%; border-radius:10px;">` : ''}
        <p><strong>××¦×¨×›×™×:</strong><br>${r.ing}</p>
        <p><strong>×”×›× ×”:</strong><br>${r.inst}</p>
    `;
    document.getElementById('edit-btn-placeholder').onclick = () => editRecipe(i);
    document.getElementById('delete-btn-placeholder').onclick = () => deleteRecipe(i);
}

async function saveRecipe(event) {
    const title = document.getElementById('recipe-title').value;
    if(!title) return alert("×¦×¨×™×š ×©×!");
    const btn = event.target;
    btn.innerText = "×©×•××¨... â³";
    btn.disabled = true;
    try {
        const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
            headers: { 'Authorization': `token ${TOKEN}` }
        });
        const fileData = await res.json();
        let content = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
        const newR = { title, ing: document.getElementById('recipe-ingredients').value, inst: document.getElementById('recipe-instructions').value, user: currentUser, img: currentImageData };
        if (editingIndex !== null) {
            const oldR = allMyRecipes[editingIndex];
            const idx = content.findIndex(item => item.title === oldR.title && item.user === currentUser);
            if(idx !== -1) content[idx] = newR;
        } else { content.push(newR); }
        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(content))));
        await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: "Save", content: encoded, sha: fileData.sha })
        });
        alert("× ×©××¨!");
        showListScreen();
    } catch (e) { alert("×©×’×™××” ×‘×©××™×¨×”"); }
    finally { btn.innerText = "×©××•×¨ ××ª×›×•×Ÿ! ğŸ‘‘"; btn.disabled = false; }
}

function readRecipe() {
    const btn = document.getElementById('speak-btn');
    if (window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); btn.innerHTML = "ğŸ”Š"; return; }
    const text = document.getElementById('full-recipe-content').innerText;
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'he-IL';
    ut.onstart = () => { btn.innerHTML = "ğŸ”‡"; };
    ut.onend = () => { btn.innerHTML = "ğŸ”Š"; };
    window.speechSynthesis.speak(ut);
}

function toggleMusic() {
    const btn = document.getElementById('music-btn');
    if (!myMagicPlayer) { myMagicPlayer = new Audio("song.mp3"); myMagicPlayer.loop = true; }
    if (myMagicPlayer.paused) {
        myMagicPlayer.play().then(() => { btn.innerHTML = "ğŸ¶"; }).catch(() => { alert("×˜×•×¢×Ÿ ××•×–×™×§×”..."); });
    } else { myMagicPlayer.pause(); btn.innerHTML = "ğŸµ"; }
}

function handleVote(t) {
    const s = document.getElementById('like-count');
    s.innerText = parseInt(s.innerText) + (t === 'up' ? 1 : -1);
}

function editRecipe(i) {
    const r = allMyRecipes[i];
    editingIndex = i;
    document.getElementById('recipe-title').value = r.title;
    document.getElementById('recipe-ingredients').value = r.ing;
    document.getElementById('recipe-instructions').value = r.inst;
    currentImageData = r.img || "";
    document.getElementById('image-preview').src = currentImageData;
    document.getElementById('image-preview').style.display = r.img ? 'block' : 'none';
    document.getElementById('single-recipe-screen').style.display = 'none';
    document.getElementById('add-recipe-screen').style.display = 'block';
}

function showListScreen() {
    document.getElementById('add-recipe-screen').style.display = 'none';
    document.getElementById('single-recipe-screen').style.display = 'none';
    document.getElementById('recipe-list-screen').style.display = 'block';
    document.getElementById('search-input').value = "";
    loadRecipes();
}

function showAddRecipeScreen() {
    editingIndex = null; 
    currentImageData = "";
    
    // ××™×¤×•×¡ ×›×œ ×”×©×“×•×ª
    document.getElementById('recipe-title').value = "";
    document.getElementById('recipe-ingredients').value = "";
    document.getElementById('recipe-instructions').value = "";
    
    // ××™×¤×•×¡ ×”×ª××•× ×” ×•×”×˜×§×¡×˜ - ×–×” ×”×—×œ×§ ×©××ª×§×Ÿ ××ª ×”×‘×¢×™×” ×©×œ×š!
    document.getElementById('image-preview').style.display = 'none';
    document.getElementById('image-preview').src = "";
    document.getElementById('drop-text').innerText = "×œ×—×¦×• ×›××Ÿ ×œ×”×•×¡×¤×ª ×ª××•× ×”"; // ××—×–×™×¨ ××ª ×”×˜×§×¡×˜ ×”××§×•×¨×™
    
    document.getElementById('recipe-list-screen').style.display = 'none';
    document.getElementById('add-recipe-screen').style.display = 'block';
}
async function deleteRecipe(i) {
    if(!confirm("×œ××—×•×§ ××ª ×”××ª×›×•×Ÿ?")) return;
    const r = allMyRecipes[i];
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
        headers: { 'Authorization': `token ${TOKEN}` }
    });
    const fd = await res.json();
    let content = JSON.parse(decodeURIComponent(escape(atob(fd.content))));
    content = content.filter(item => !(item.title === r.title && item.user === currentUser));
    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(content))));
    await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`, {
        method: 'PUT',
        headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: "Delete", content: encoded, sha: fd.sha })
    });
    showListScreen();
}
</script>
</body>
</html>


